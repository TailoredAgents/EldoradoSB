generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProspectStatus {
  new
  queued
  contacted
  replied
  negotiating
  signed
  rejected
  dnc
  done
}

enum OutreachChannel {
  dm
  email
}

enum WorkerRunStatus {
  started
  skipped_disabled
  skipped_budget
  success
  error
}

enum CampaignType {
  depositors
  ambassadors
  mixed
}

enum XActionType {
  post
  reply
  dm
  outbound_comment
  inbound_scan
  oauth_connect
  oauth_refresh
}

enum XActionStatus {
  success
  skipped
  error
}

enum XHandledItemType {
  mention_tweet
  dm_event
  outbound_target_tweet
  autopost_slot
}

enum XHandledItemStatus {
  reserved
  done
  error
}

model Prospect {
  id        String         @id @default(cuid())
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  xUserId   String         @unique
  handle    String
  name      String?

  bio       String?
  url       String?
  location  String?

  followers Int?
  verified  Boolean?

  status    ProspectStatus @default(new)
  owner     String?

  usFocusConfidence Float?

  performanceScore Float?
  acceptanceScore  Float?
  overallScore     Float?
  tier             String?
  primarySport     String?

  queuedAt  DateTime?
  queuedDay DateTime?

  dmDraft        String?
  emailSubject   String?
  emailBody      String?
  draftedAt      DateTime?

  lastSampledAt  DateTime?
  lastAnalyzedAt DateTime?

  firstDiscoveredAt      DateTime?
  firstDiscoveredQueryId String?

  rationale Json?
  notes     String?

  postSamples    PostSample[]
  scoreHistory   ScoreHistory[]
  outreachEvents OutreachEvent[]

  @@index([status])
  @@index([tier])
  @@index([owner])
  @@index([followers])
  @@index([overallScore])
  @@index([queuedDay])
  @@index([primarySport])
}

model PostSample {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  postId    String   @unique
  postedAt  DateTime?
  text      String
  permalink String?

  likes     Int?
  replies   Int?
  reposts   Int?
  quotes    Int?

  sampledAt DateTime @default(now())

  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  prospectId String

  @@index([prospectId])
  @@index([sampledAt])
}

model ScoreHistory {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  computedAt DateTime @default(now())

  inputsHash String
  features   Json?

  performanceScore Float?
  acceptanceScore  Float?
  overallScore     Float?
  tier             String?
  rationale        Json?

  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  prospectId String

  @@unique([prospectId, inputsHash])
  @@index([computedAt])
  @@index([tier])
}

model OutreachEvent {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  eventAt   DateTime        @default(now())

  channel   OutreachChannel
  eventType String

  templateUsed String?
  outcome      String?
  followUpAt   DateTime?
  notes        String?

  depositors   Int?
  depositsUsd  Float?

  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  prospectId String

  @@index([prospectId])
  @@index([eventAt])
  @@index([channel])
}

model Settings {
  id        Int      @id @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enabled Boolean @default(true)

  maxPostReadsPerRun Int @default(25)
  maxPostReadsPerDay Int @default(400)

  // Secondary/optional: legacy ambassador prospecting pipeline (discovery/sampling/LLM scoring/writing).
  prospectPipelineEnabled Boolean @default(false)
  maxProspectPipelinePostReadsPerRun Int @default(15)

  queueValueCount      Int @default(12)
  queueAcceptanceCount Int @default(6)
  queueExplorationCount Int @default(2)

  disclaimerText String?
  templates      Json?
}

model UsageLedger {
  date DateTime @id

  xPostReads   Int @default(0)
  xUserLookups Int @default(0)

  llmTokensByModel Json?
  estimatedCostUsd Float?
}

model WorkerRun {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  startedAt DateTime        @default(now())
  finishedAt DateTime?

  status    WorkerRunStatus @default(started)
  dryRun    Boolean         @default(false)

  xPostReadsDelta   Int @default(0)
  xUserLookupsDelta Int @default(0)

  stats        Json?
  errorMessage String?

  @@index([startedAt])
  @@index([status])
}

model Campaign {
  id        String       @id @default(cuid())
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  name   String
  type   CampaignType @default(mixed)
  active Boolean      @default(true)

  trackingLinks TrackingLink[]
  weeklyDepositResults WeeklyDepositResult[]
}

model TrackingLink {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  token          String  @unique
  label          String?
  destinationUrl String
  active         Boolean @default(true)

  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId String

  clickEvents ClickEvent[]

  @@index([campaignId])
}

model ClickEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  referrer  String?
  userAgent String?

  trackingLink   TrackingLink @relation(fields: [trackingLinkId], references: [id], onDelete: Cascade)
  trackingLinkId String

  @@index([trackingLinkId])
  @@index([createdAt])
}

model XCredential {
  id        Int      @id @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accessTokenEnc  String
  refreshTokenEnc String?
  tokenType       String?
  scope           String?
  expiresAt       DateTime?
}

model XAccountSettings {
  id        Int      @id @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enabled          Boolean @default(false)
  autoPostEnabled  Boolean @default(false)
  autoReplyEnabled Boolean @default(false)
  outboundEnabled  Boolean @default(false)

  publicBaseUrl String?

  // Optional: stable tracked-link tokens to attribute DM "LINK" requests and clicks by tier.
  // When publicBaseUrl is set, inbound auto-replies can send ${publicBaseUrl}/r/${token}.
  linkTokenDefault String?
  linkTokenPayout  String?
  linkTokenPicks   String?
  linkTokenGen     String?

  maxPostsPerDay          Int @default(3)
  maxAutoRepliesPerDay    Int @default(60)
  maxOutboundRepliesPerDay Int @default(10)
  maxOutboundRepliesPerRun Int @default(10)

  // Pay-per-use guardrail (UTC day): if set, worker will throttle reads when X "posts consumed" reaches this cap.
  maxPostsConsumedPerUtcDay Int?

  // Schedule stored as JSON for flexibility. Example: { "posts": ["11:00", "16:00", "21:30"] }
  schedule Json?

  disclaimerText String?
}

model WeeklyDepositResult {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Week start date (stored in UTC; treat as ET week buckets in UI).
  weekStart DateTime

  // Attribution bucket. Set either tier or campaignId.
  tier String?

  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignId String?

  depositors  Int   @default(0)
  depositsUsd Float @default(0)

  notes String?

  @@index([weekStart])
  @@index([tier])
  @@index([campaignId])
  @@unique([weekStart, tier, campaignId])
}

model XActionLog {
  id        String        @id @default(cuid())
  createdAt DateTime      @default(now())

  actionType XActionType
  status     XActionStatus @default(success)

  reason String?
  meta   Json?

  xId String?

  @@index([createdAt])
  @@index([actionType])
  @@index([status])
}

model ConversationMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // e.g. "x", "reddit"
  platform  String

  // External message/event id. Uniqued with platform.
  externalId String

  // Logical thread key for grouping, e.g. "x_dm:<userId>".
  threadKey String

  // "inbound" (from user) or "outbound" (from us)
  direction String

  // The non-Eldorado user id when known (e.g. X user id for DMs).
  userId String?

  // Redacted text, safe for export/training.
  text String

  meta Json?

  @@unique([platform, externalId])
  @@index([createdAt])
  @@index([platform, threadKey, createdAt])
  @@index([platform, userId, createdAt])
}

model HandledItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform  String
  type      String
  externalId String

  status    String   @default("reserved") // reserved | done | error
  lastError String?
  retryAfter DateTime?

  @@unique([platform, type, externalId])
  @@index([platform, status])
  @@index([createdAt])
}

model RedditAccountSettings {
  id        Int      @id @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enabled        Boolean @default(false)
  outboundEnabled Boolean @default(false)
  inboundEnabled Boolean @default(false)

  maxCommentsPerDay Int @default(8)
  maxCommentsPerRun Int @default(2)

  // Percent of comments that include a soft CTA (only for subreddits allowlisted for CTA).
  ctaPercent Int @default(15)

  // JSON config:
  // { "subreddits": [{ "name": "sportsbook", "allowCta": false }, ...], "xHandle": "EldoradoSB" }
  config Json?
}

model XHandledItem {
  id        String            @id @default(cuid())
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  type       XHandledItemType
  externalId String
  status     XHandledItemStatus @default(reserved)

  lastError String?

  @@unique([type, externalId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model XAccountState {
  id        Int      @id @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lastMentionId String?
  lastDmEventId String?
}
